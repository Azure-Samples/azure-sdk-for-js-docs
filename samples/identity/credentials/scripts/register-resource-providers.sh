#!/bin/bash

# Script to register all NotRegistered Azure resource providers
# This script registers providers that have RegistrationPolicy = RegistrationRequired
# and RegistrationState = NotRegistered

# Don't exit on error - we want to continue registering even if some fail
set +e

echo "Starting Azure Resource Provider Registration..."
echo "================================================"
echo ""

# Array of resource providers to register
PROVIDERS=(
    "ArizeAi.ObservabilityEval"
    "Astronomer.Astro"
    "Dell.Storage"
    "Dynatrace.Observability"
    "GitHub.Network"
    "Informatica.DataManagement"
    "LambdaTest.HyperExecute"
    "Liftrbasic.Samplerp"
    "Microsoft.AAD"
    "Microsoft.AadCustomSecurityAttributesDiagnosticSettings"
    "microsoft.aadiam"
    "Microsoft.Addons"
    "Microsoft.Advisor"
    "Microsoft.AgFoodPlatform"
    "Microsoft.AgriculturePlatform"
    "Microsoft.AlertsManagement"
    "Microsoft.AnalysisServices"
    "Microsoft.ApiCenter"
    "Microsoft.ApiManagement"
    "Microsoft.App"
    "Microsoft.AppAssessment"
    "Microsoft.AppComplianceAutomation"
    "Microsoft.AppConfiguration"
    "Microsoft.ApplicationMigration"
    "Microsoft.AppLink"
    "Microsoft.AppPlatform"
    "Microsoft.ArcContainerStorage"
    "Microsoft.Attestation"
    "Microsoft.Automanage"
    "Microsoft.Automation"
    "Microsoft.AVS"
    "Microsoft.AwsConnector"
    "Microsoft.AzureActiveDirectory"
    "Microsoft.AzureArcData"
    "Microsoft.AzureBusinessContinuity"
    "Microsoft.AzureDataTransfer"
    "Microsoft.AzureFleet"
    "Microsoft.AzureImageTestingForLinux"
    "Microsoft.AzureLargeInstance"
    "Microsoft.AzurePlaywrightService"
    "Microsoft.AzureResilienceManagement"
    "Microsoft.AzureScan"
    "Microsoft.AzureSphere"
    "Microsoft.AzureStack"
    "Microsoft.AzureStackHCI"
    "Microsoft.AzureTerraform"
    "Microsoft.BackupSolutions"
    "Microsoft.BareMetal"
    "Microsoft.BareMetalInfrastructure"
    "Microsoft.Batch"
    "Microsoft.BillingBenefits"
    "Microsoft.Bing"
    "Microsoft.BlockchainTokens"
    "Microsoft.Blueprint"
    "Microsoft.BotService"
    "Microsoft.Cache"
    "Microsoft.Capacity"
    "Microsoft.Carbon"
    "Microsoft.Cdn"
    "Microsoft.CertificateRegistration"
    "Microsoft.ChangeAnalysis"
    "Microsoft.Chaos"
    "Microsoft.ClassicCompute"
    "Microsoft.ClassicInfrastructureMigrate"
    "Microsoft.ClassicNetwork"
    "Microsoft.ClassicStorage"
    "Microsoft.CleanRoom"
    "Microsoft.CloudDevicePlatform"
    "Microsoft.CloudHealth"
    "Microsoft.CloudShell"
    "Microsoft.CloudTest"
    "Microsoft.CodeSigning"
    "Microsoft.CognitiveServices"
    "Microsoft.Communication"
    "Microsoft.Community"
    "Microsoft.Compute"
    "Microsoft.ComputeSchedule"
    "Microsoft.ConfidentialLedger"
    "Microsoft.Confluent"
    "Microsoft.ConnectedCache"
    "Microsoft.ConnectedCredentials"
    "microsoft.connectedopenstack"
    "Microsoft.ConnectedVehicle"
    "Microsoft.ConnectedVMwarevSphere"
    "Microsoft.ContainerInstance"
    "Microsoft.ContainerRegistry"
    "Microsoft.ContainerService"
    "Microsoft.CostManagementExports"
    "Microsoft.CustomerLockbox"
    "Microsoft.CustomProviders"
    "Microsoft.D365CustomerInsights"
    "Microsoft.Dashboard"
    "Microsoft.DatabaseFleetManager"
    "Microsoft.DatabaseWatcher"
    "Microsoft.DataBox"
    "Microsoft.DataBoxEdge"
    "Microsoft.Databricks"
    "Microsoft.Datadog"
    "Microsoft.DataFactory"
    "Microsoft.DataLakeAnalytics"
    "Microsoft.DataLakeStore"
    "Microsoft.DataMigration"
    "Microsoft.DataProtection"
    "Microsoft.DataReplication"
    "Microsoft.DataShare"
    "Microsoft.DBforMariaDB"
    "Microsoft.DBforMySQL"
    "Microsoft.DBforPostgreSQL"
    "Microsoft.DependencyMap"
    "Microsoft.DesktopVirtualization"
    "Microsoft.DevCenter"
    "Microsoft.DevelopmentWindows365"
    "Microsoft.DevHub"
    "Microsoft.DeviceOnboarding"
    "Microsoft.DeviceRegistry"
    "Microsoft.Devices"
    "Microsoft.DeviceUpdate"
    "Microsoft.DevOpsInfrastructure"
    "Microsoft.DevTestLab"
    "Microsoft.DigitalTwins"
    "Microsoft.Discovery"
    "Microsoft.DocumentDB"
    "Microsoft.DomainRegistration"
    "Microsoft.DurableTask"
    "Microsoft.Easm"
    "Microsoft.Edge"
    "Microsoft.EdgeManagement"
    "Microsoft.EdgeMarketplace"
    "Microsoft.EdgeOrder"
    "Microsoft.EdgeOrderPartner"
    "Microsoft.EdgeZones"
    "Microsoft.Elastic"
    "Microsoft.ElasticSan"
    "Microsoft.EnterpriseSupport"
    "Microsoft.EntitlementManagement"
    "Microsoft.EntraIDGovernance"
    "Microsoft.ErrorAtlas"
    "Microsoft.EventGrid"
    "Microsoft.EventHub"
    "Microsoft.Experimentation"
    "Microsoft.ExtendedLocation"
    "Microsoft.Fabric"
    "Microsoft.FileShares"
    "Microsoft.FluidRelay"
    "Microsoft.GCPConnector"
    "Microsoft.GraphServices"
    "Microsoft.GuestConfiguration"
    "Microsoft.HanaOnAzure"
    "Microsoft.HardwareSecurityModules"
    "Microsoft.HDInsight"
    "Microsoft.HealthBot"
    "Microsoft.HealthcareApis"
    "Microsoft.HealthcareInterop"
    "Microsoft.HealthDataAIServices"
    "Microsoft.HealthModel"
    "Microsoft.HealthPlatform"
    "Microsoft.Help"
    "Microsoft.HybridCloud"
    "Microsoft.HybridCompute"
    "Microsoft.HybridConnectivity"
    "Microsoft.HybridContainerService"
    "Microsoft.HybridNetwork"
    "Microsoft.Impact"
    "microsoft.insights"
    "Microsoft.IntegrationSpaces"
    "Microsoft.IoTCentral"
    "Microsoft.IoTFirmwareDefense"
    "Microsoft.IoTOperations"
    "Microsoft.IoTOperationsDataProcessor"
    "Microsoft.IoTSecurity"
    "Microsoft.KeyVault"
    "Microsoft.Kubernetes"
    "Microsoft.KubernetesConfiguration"
    "Microsoft.KubernetesRuntime"
    "Microsoft.Kusto"
    "Microsoft.LabServices"
    "Microsoft.LoadTestService"
    "Microsoft.Logic"
    "Microsoft.MachineLearningServices"
    "Microsoft.Maintenance"
    "Microsoft.ManagedIdentity"
    "Microsoft.ManagedNetworkFabric"
    "Microsoft.ManagedServices"
    "Microsoft.Management"
    "Microsoft.Maps"
    "Microsoft.Marketplace"
    "Microsoft.MessagingCatalog"
    "Microsoft.MessagingConnectors"
    "Microsoft.Migrate"
    "Microsoft.Mission"
    "Microsoft.MixedReality"
    "Microsoft.Monitor"
    "Microsoft.MySQLDiscovery"
    "Microsoft.NetApp"
    "Microsoft.Network"
    "Microsoft.NetworkCloud"
    "Microsoft.NetworkFunction"
    "Microsoft.NexusIdentity"
    "Microsoft.NotificationHubs"
    "Microsoft.Nutanix"
    "Microsoft.ObjectStore"
    "Microsoft.OffAzure"
    "Microsoft.OffAzureSpringBoot"
    "Microsoft.OnlineExperimentation"
    "Microsoft.OpenEnergyPlatform"
    "Microsoft.OperationalInsights"
    "Microsoft.OperationsManagement"
    "Microsoft.OperatorVoicemail"
    "Microsoft.OracleDiscovery"
    "Microsoft.Orbital"
    "Microsoft.PartnerManagedConsumerRecurrence"
    "Microsoft.Peering"
    "Microsoft.Pki"
    "Microsoft.PolicyInsights"
    "Microsoft.PortalServices"
    "Microsoft.PowerBI"
    "Microsoft.PowerBIDedicated"
    "Microsoft.PowerPlatform"
    "Microsoft.Premonition"
    "Microsoft.ProfessionalService"
    "Microsoft.ProviderHub"
    "Microsoft.Purview"
    "Microsoft.Quantum"
    "Microsoft.Quota"
    "Microsoft.RecommendationsService"
    "Microsoft.RecoveryServices"
    "Microsoft.RedHatOpenShift"
    "Microsoft.Relationships"
    "Microsoft.Relay"
    "Microsoft.ResourceConnector"
    "Microsoft.ResourceHealth"
    "Microsoft.SaaS"
    "Microsoft.SaaSHub"
    "Microsoft.Scom"
    "Microsoft.SCVMM"
    "Microsoft.Search"
    "Microsoft.SecretSyncController"
    "Microsoft.Security"
    "Microsoft.SecurityCopilot"
    "Microsoft.SecurityDetonation"
    "Microsoft.SecurityInsights"
    "Microsoft.SecurityPlatform"
    "Microsoft.SentinelPlatformServices"
    "Microsoft.ServiceBus"
    "Microsoft.ServiceFabric"
    "Microsoft.ServiceFabricMesh"
    "Microsoft.ServiceLinker"
    "Microsoft.ServiceNetworking"
    "Microsoft.ServicesHub"
    "Microsoft.SignalRService"
    "Microsoft.Singularity"
    "Microsoft.SoftwarePlan"
    "Microsoft.Solutions"
    "Microsoft.Sovereign"
    "Microsoft.Sql"
    "Microsoft.SqlVirtualMachine"
    "Microsoft.StandbyPool"
    "Microsoft.Storage"
    "Microsoft.StorageActions"
    "Microsoft.StorageCache"
    "Microsoft.StorageDiscovery"
    "Microsoft.StorageMover"
    "Microsoft.StorageSync"
    "Microsoft.StorageTasks"
    "Microsoft.StreamAnalytics"
    "Microsoft.Subscription"
    "Microsoft.SupercomputerInfrastructure"
    "Microsoft.SustainabilityServices"
    "Microsoft.Synapse"
    "Microsoft.Syntex"
    "Microsoft.ToolchainOrchestrator"
    "Microsoft.UpdateManager"
    "Microsoft.UsageBilling"
    "Microsoft.VerifiedId"
    "Microsoft.VideoIndexer"
    "Microsoft.VirtualMachineImages"
    "microsoft.visualstudio"
    "Microsoft.VMware"
    "Microsoft.VoiceServices"
    "Microsoft.Web"
    "Microsoft.WeightsAndBiases"
    "Microsoft.Windows365"
    "Microsoft.WindowsPushNotificationServices"
    "Microsoft.WorkloadBuilder"
    "Microsoft.Workloads"
    "MongoDB.Atlas"
    "Neon.Postgres"
    "NewRelic.Observability"
    "NGINX.NGINXPLUS"
    "Oracle.Database"
    "PaloAltoNetworks.Cloudngfw"
    "Pinecone.VectorDb"
    "PureStorage.Block"
    "Qumulo.Storage"
)

# Counter for tracking progress
TOTAL=${#PROVIDERS[@]}
SUCCESS=0
FAILED=0
ALREADY_REGISTERED=0

echo "Total providers to register: $TOTAL"
echo ""

# Function to register a single provider
register_provider() {
    local provider=$1
    local current=$((SUCCESS + FAILED + ALREADY_REGISTERED + 1))
    printf "[%3d/%3d] Registering %-60s ... " "$current" "$TOTAL" "$provider"
    
    # Try to register the provider
    local output
    output=$(az provider register --namespace "$provider" 2>&1)
    local exit_code=$?
    
    if [ $exit_code -eq 0 ]; then
        if echo "$output" | grep -qi "already.*registered"; then
            echo "✓ (already registered)"
            ((ALREADY_REGISTERED++))
        else
            echo "✓ (registered - may take a few minutes to complete)"
            ((SUCCESS++))
        fi
    else
        echo "✗ Failed"
        echo "   Error: $output"
        ((FAILED++))
    fi
}

# Check if Azure CLI is installed and user is logged in
if ! command -v az &> /dev/null; then
    echo "Error: Azure CLI is not installed. Please install it first."
    echo "Visit: https://docs.microsoft.com/en-us/cli/azure/install-azure-cli"
    exit 1
fi

# Check if user is logged in
if ! az account show > /dev/null 2>&1; then
    echo "Error: Not logged in to Azure. Please run 'az login' first."
    exit 1
fi

echo "Current Azure subscription:"
az account show --query "{Name:name, ID:id}" -o table
echo ""

# Register all providers
for provider in "${PROVIDERS[@]}"; do
    register_provider "$provider"
done

echo ""
echo "================================================"
echo "Registration Summary:"
echo "  Successfully registered: $SUCCESS"
echo "  Already registered: $ALREADY_REGISTERED"
echo "  Failed: $FAILED"
echo "  Total: $TOTAL"
echo "================================================"

if [ $FAILED -gt 0 ]; then
    echo ""
    echo "Note: Some providers may have failed due to permissions or subscription limitations."
    echo "You can check the status with: az provider list --query \"[?registrationState=='NotRegistered']\" -o table"
    exit 1
fi

echo ""
echo "All providers have been processed successfully!"
echo "Note: Some providers may take a few minutes to complete registration."
echo "Check status with: az provider list -o table"
